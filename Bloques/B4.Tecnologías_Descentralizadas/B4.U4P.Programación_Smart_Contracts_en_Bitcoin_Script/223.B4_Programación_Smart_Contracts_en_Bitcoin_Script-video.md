---
title: Práctica | Programación Smart Contracts en Bitcoin Script | José Maldonado
URL: https://app.web3mba.io/courses/take/bloque-4-tecnologias-descentralizadas/lessons/38966771-practica-programacion-smart-contracts-en-bitcoin-script-jose-maldonado
Tags/Keywords: #Bloque 4 #tecnologias descentralizadas #B4U4 #smart contracts sobre bitcoin #bitcoin #btc #Práctica #Programación Smart Contracts en Bitcoin Script #José Maldonado #bitcoin script
lang: es-AR
---
# Programación Smart Contracts en Bitcoin Script
![[223.B4_Programación_Smart_Contracts_en_Bitcoin_Script.mp4]]
[Programacion Smart Contracts en Bitcoin Script](https://app.web3mba.io?wvideo=j18970hyft)


Saludos, en este video les explicaremos uno de los pilares fundamentales que permiten que Bitcoin pueda ser lo que llamamos dinero digital programable. Esto es posible gracias a Bitcoin Script, un sistema de scripting que le permite a Bitcoin programar de forma interna las operaciones que se realizan dentro de su red blockchain o la red de nodos que forman parte de esta red conocida como Bitcoin.

Bitcoin Script es un lenguaje de programación bastante sencillo; es muy pequeño en sus aspectos y en lo que puedes hacer con él, pero tiene una funcionalidad muy relevante: permitir a los programadores de la red Bitcoin y a los usuarios transferir valor de forma completamente digital y programable entre los diferentes pares que están dentro de la red. No solamente eso, Bitcoin Script es lo que se encarga de hacer posible que mis transferencias, o las transferencias que hagamos dentro de la red, lleguen desde el punto A al punto B de forma segura y que solo las personas que están en medio de esa transacción sean las autorizadas para poder utilizar este valor que se está transmitiendo.

¿Cómo hace posible esto Bitcoin Script? Pues bien, Bitcoin Script utiliza el poder de la criptografía junto con el de la programación para habilitar a los usuarios de la red en el uso de las diferentes transacciones que se realizan. Por ejemplo, si yo, como usuario, transmito dinero utilizando mis entradas de Bitcoin a una persona, estoy utilizando mis entradas y para eso genero un script específico que me permite desbloquearlas y enviarlas a esa segunda persona. Esta persona, entonces, tendrá la habilidad de utilizar sus propios scripts y realizar los pagos consecuentes que vaya a hacer después de recibir este dinero. Por supuesto, todo esto que estoy diciendo pasa completamente desapercibido porque se realiza de forma transparente al usuario. La idea de Bitcoin Script es que los programadores de Bitcoin puedan habilitar opciones de transacciones digitales completamente nuevas para la red y que esto sea completamente transparente para los usuarios, porque lo único que importa en este punto es que puedan realizar sus operaciones sin mayores inconvenientes.

Ahora bien, Bitcoin Script es normalmente conocido como un lenguaje del tipo stack o de pila. Es decir, las operaciones que se realizan con Bitcoin Script se apilan unas sobre otras y luego se ejecutan para tener una entrada de datos y una salida de la misma. Esto facilita la generación de nodos que puedan interpretar toda esta información de forma bastante universal y que todos los nodos tengan un consenso sobre si una transacción es válida o no. Para ello, Bitcoin Script se vale de una serie de instrucciones que se conocen como opcodes o códigos de operación. En la página oficial de Bitcoin, podemos ver cuáles son estos opcodes. Los opcodes simplemente nos permiten introducir datos dentro de Bitcoin Script para que sean validados o ejecutados por los diferentes nodos.

Este es un punto muy importante que quiero enfatizar: al igual que en Ethereum, donde programamos algo en Solidity y la Ethereum Virtual Machine procesa esa información, en Bitcoin ocurre algo similar, pero a un nivel mucho más sencillo. En Bitcoin no tenemos una máquina virtual como tal, sino un ejecutor que se encarga de tomar el Bitcoin Script, realizar las ejecuciones o las operaciones que está pidiendo y tener la certeza de si la operación es válida para incluirla dentro de los bloques.

Ahora bien, ¿qué operaciones podemos hacer o qué rango de operaciones tenemos disponibles dentro de Bitcoin Script? Aquí, en la página, podemos ver la anotación que tenemos disponible. Varios de estos códigos han sido desactivados por los desarrolladores de Bitcoin debido a problemas de seguridad. La idea es mantener Bitcoin Script lo más sencillo y seguro posible. Entre esas anotaciones y operaciones que podemos realizar, podemos encontrar los siguientes opcodes y las diferentes capacidades que pueden realizar. Por ejemplo, en la parte de constantes, podemos definir constantes con palabras como OP_0 o OP_FALSE, que nos permiten identificar un arreglo de datos vacíos dentro del stack que se está ejecutando en Bitcoin Script. Recordemos que esto significa que se llevará al stack un dato vacío que no tiene ningún valor para que sea identificado y analizado por el ejecutor de Bitcoin Script dentro de los nodos.

También tenemos operaciones especiales como OP_PUSH_DATA, que simplemente nos indican que debemos añadir una determinada cantidad de datos a la pila, dependiendo de una entrada que le estemos otorgando. También tenemos OP_ENGAGE, que lleva el número menos uno al stack, o hacer OP_1_TRUE, OP_1 o OP_TRUE, que serían operaciones del tipo lógico dentro del stack. Además, tenemos códigos de operaciones que nos permiten hacer control de flujo. Esto es importante porque recordemos que Bitcoin Script no solo es un lenguaje de script, es un lenguaje de programación limitado en sus funciones, pero que aún así tiene la capacidad de controlar el flujo. Es decir, la capacidad de decidir si se hace una iteración o no, dependiendo de determinadas condiciones. Para ello, tenemos códigos como OP_NOP, que no hace nada, OP_IF, que ejecuta una determinada condición si se cumple, OP_NOT_IF, que es lo contrario, y OP_ELSE, que es otra opción de control de flujo bastante utilizada. También tenemos OP_ENDIF, que se utiliza para finalizar una operación en caso de que sea inválida, OP_VERIFY, que es la verificación de una operación, y OP_RETURN, que simplemente nos ayuda a marcar nuestra situación como inválida y se utiliza en muchas operaciones como base para realizar las Coinbase. OP_RETURN es una de las operaciones más utilizadas en este sentido porque nos permite añadir información que no debe ser analizada directamente, sino que es marcada como inválida o que se puede agregar a la blockchain sin ningún tipo de procesamiento por parte de la máquina de consenso dentro de Bitcoin.

También tenemos el control del stack, que incluye varias operaciones, como la duplicación del stack, la apertura del stack y la eliminación de una instrucción. Para eliminar una instrucción se utiliza el opcode OP_DROP, para duplicar se utiliza el opcode OP_DUP, y así sucesivamente tenemos una serie de operaciones que nos permiten manejar diferentes operaciones que podríamos utilizar dentro de las capacidades de Bitcoin Script. Un apunte importante: siendo Bitcoin dinero programable, está la capacidad de realizar operaciones aritméticas. Sumar, restar y multiplicar son operaciones posibles utilizando Bitcoin Script. Para ello, contamos con varios opcodes que son los que vemos aquí ahora en pantalla, como el opcode para sumar, sustraer, multiplicar y dividir. Es muy importante mencionar que los opcodes de multiplicación y división están desactivados debido a un problema que se descubrió dentro de Bitcoin, que permitía a ciertos usuarios manipular estos opcodes para realizar operaciones mal formadas que fueran validadas por el nodo y que al final pudieran permitirles obtener ingresos de forma maliciosa. Estos opcodes fueron desactivados por el equipo y desde entonces se han mantenido así.

Fíjense que no son los únicos. Hay varios opcodes, por ejemplo, los de lógica y de splice, que también están desactivados por razones de seguridad. También vemos que tenemos opcodes para multiplicación, división, módulo y otras operaciones aritméticas, como verificar si un número es igual a otro, si es menor o igual, o si es mayor. Este tipo de operaciones también se pueden realizar con el sistema de Bitcoin Script.

En un principio, también mencioné que con Bitcoin Script se pueden hacer operaciones de tipo criptográfico. Esto tiene sentido porque la manera en que verificamos operaciones dentro de Bitcoin utiliza la criptografía. Para ello, Bitcoin Script tiene las siguientes funciones o códigos de operación disponibles: RIPEMD-160, que utiliza el hash RIPEMD-160 dentro de una operación, SHA-1, SHA-256, que es el SHA-256 que hemos visto en otros videos, OP_HASH160, que aplica SHA-256 y RIPEMD-160 para generar diferentes hashes especiales para Bitcoin, como la dirección de una cuenta de Bitcoin. También está OP_CODESEPARATOR, que es una operación que realmente no hace nada, sino que realiza un chequeo de firmas. OP_CHECKSIG, que verifica si una firma pública añadida dentro de Bitcoin Script es correcta, dependiendo de los datos que le hayamos otorgado. CHECKSIGVERIFY, que es la verificación de esa firma, y OP_CHECKMULTISIG, que nos permite crear monederos de múltiples firmas. Esta es la operación que hace posible esa capacidad.

También tenemos operaciones de lock time o de bloqueo por tiempo, como OP_CHECKLOCKTIMEVERIFY, o CLTV, que es una transacción especial que nos permite bloquear determinadas cantidades de criptomonedas, en este caso Bitcoin, por un tiempo determinado hasta que se verifiquen o se cumplan ciertas condiciones. También tenemos, en un sentido similar, OP_CHECKSEQUENCEVERIFY, o CSV, que tiene funciones parecidas a CLTV, pero que en este caso, en vez de utilizar un lock time, utiliza un sistema de secuencias, tal como lo ejemplifica el BIP 0060, que es el que se encarga de este tipo de operaciones.

Ahora bien, ya que conocemos un poco las operaciones que están dentro de Bitcoin Script y sus diferentes opcodes, recomiendo leer y reconocer bien esta página si quieres entrar en el mundo de la programación de Bitcoin directamente con Bitcoin Script. Sin embargo, no es la única manera de hacerlo. Puedes utilizar wrappers como Python o BTC, que te permiten programar operaciones con Python, pero que luego son traducidas a los opcodes necesarios para generar transacciones que puedan ser entendidas por la red Bitcoin. En todo caso, esta lista de operaciones que están aquí de opcodes nos dice algo muy claro sobre Bitcoin Script: podemos programar operaciones de distintas índoles con él. Esto elimina un poco la idea de que Bitcoin Script no tiene la capacidad de programar smart contracts.

Bitcoin Script tiene la capacidad de programar smart contracts. De hecho, cada vez que haces una transacción en Bitcoin, las operaciones de distintas índoles se pueden programar en el mismo sistema. Esto es lo que nos permite programar una transacción en Bitcoin Script. Esta transacción es posible por un pequeño smart contract dentro de esa operación, porque Bitcoin Script es un lenguaje de tipo smart contract. La diferencia entre los smart contracts de Ethereum y los de Bitcoin es que los smart contracts de Bitcoin no son Turing completos. ¿Qué significa esto? Que no podemos crear estructuras extremadamente complejas en comparación con lo que podemos hacer con Solidity. Por ejemplo, no podríamos crear un oráculo blockchain, como Chainlink, sobre Bitcoin, porque no hay capacidad para este tipo de operaciones. Sin embargo, los desarrolladores de Bitcoin entienden que estas limitaciones deben ser superadas y para eso se han creado diferentes sistemas, como Miniscript y los wrappers que he comentado para Python o para otros lenguajes de programación.

Estos wrappers y extensiones buscan llevar a Bitcoin a más lugares para que su uso sea potenciado. Más allá de esto, para ver cómo funciona Bitcoin Script en realidad, vamos a ver unos pequeños ejemplos que les mostraré en pantalla para que vean cómo es la programación de un Bitcoin Script y hasta dónde se puede llevar este potencial. Vamos a reducir un poco esta pantalla aquí y vamos a nuestra consola. En este caso, ya tenemos algunos ejemplos preparados. Voy a mostrar el ejemplo número uno. En este caso, tenemos un comando llamado btcd, que contiene una serie de datos que iré demostrando. Este primer dato que ustedes ven aquí es nuestra firma de Bitcoin. Luego viene la firma hashada y aquí están nuestras operaciones. Voy a poner esto aquí de manera que podamos revisarlo poco a poco.

Esta línea que estoy recorriendo en pantalla es una dirección de Bitcoin. Pueden verificarla directamente en un mempool. Aquí están nuestras operaciones completas. Muy bien. Aquí lo que vemos es lo siguiente: estas dos líneas pertenecen a nuestro script de verificación. Nuestro script de verificación contiene la información de nuestra llave pública y la firma correspondiente para movilizar una determinada cantidad de criptomonedas que estén dentro de una dirección. En este caso, la dirección que estamos viendo es la dirección 12AB8. Esto le dice a Bitcoin Script que tenemos esta dirección, esta firma y estos scripts. Vamos a tomar estos scripts, los vas a ejecutar dentro de un nodo y vas a verificar si todo es correcto. Si todo es correcto, esta persona puede movilizar el dinero que está en esa dirección y enviarlo a quien lo está enviando.

Entonces, el primer cuerpo que tenemos aquí, estas dos primeras líneas, sería nuestro script de verificación. Luego viene nuestro script como tal. Aquí lo primero que hacemos es duplicar la pila, que tomará esta información y la duplicará. Luego, haremos un hash 160, es decir, realizaremos un hash RIPEMD-160 y doble SHA-256. Después, tomaremos esta dirección y verificaremos si son iguales, y luego verificaremos las firmas. Para ejecutar esto y verlo más gráficamente, vamos a salir un momento aquí. Vamos a limpiar la pantalla. Haremos lo siguiente: bash ejemplo 01. Vamos a ejecutar un depurador llamado btcdep, que podemos buscar aquí. Vamos a buscar rápidamente antes de mostrarles dónde pueden encontrar este depurador. Aquí está: este es el Bitcoin Script Debugger, un depurador oficial de Bitcoin que pueden utilizar con completa confianza. Es bastante sencillo de compilar para que se pueda agregar su funcionamiento.

Ahora que sabemos dónde conseguir la herramienta BTCDEP, que es la que vamos a utilizar, vamos a ejecutar un pequeño script con un ejemplo de transacción que ya hemos modificado, que es el ejemplo que estábamos viendo en pantalla. Vamos a limpiar la pantalla nuevamente. Haremos bash ejemplo 01. Aquí tenemos a BTCDEP ejecutando nuestro script. En este caso, el script que había mostrado en pantalla ya está cargado. Aquí podemos ver el script en forma de pila y vamos a ir ejecutando paso a paso cada una de estas operaciones. El primer paso es tomar y duplicar todo el stack superior. Ya está. PushStack se ha duplicado. Ya tenemos el primer paso aquí. Seguimos al segundo paso. La pila se sigue reduciendo y vamos haciendo la ejecución continua de este script. Lo siguiente que hacemos es duplicar nuevamente la línea anterior y aquí tenemos el script ya duplicado. Fíjense que tenemos nuestras firmas ya duplicadas.

Bien, vamos a hacer entonces el siguiente paso, que es aplicar el OP_HASH160. ¿Qué va a pasar aquí? Lo que sucederá es que tomaremos la firma pública, que en este caso es la 044, y la transformaremos en una dirección de Bitcoin, que debería ser igual a la dirección 12AB8 que estamos viendo aquí abajo. Vamos a ejecutar el siguiente paso y deberíamos obtener la dirección. Efectivamente, en el lado del script tenemos nuestra dirección, 12AB8, y en el lado del stack ejecutándose dentro de BTCDEP, tenemos la misma dirección. La firma que estamos tomando de esta operación es correcta y nos está generando la dirección que necesitamos para hacer la verificación. Ahora, el siguiente paso es enviar la firma que nos está dando el script. Y ahí está. Ahora, estas dos firmas que están aquí las vamos a verificar con OP_EQUALVERIFY. Ejecutamos el siguiente paso y efectivamente, las operaciones son correctas. El script nos está diciendo que las direcciones son idénticas y, por ser idénticas, nos da la capacidad para seguir con la operación. Finalmente, lo que quedaría es verificar si la firma es correcta y pertenece a quien dice pertenecer. Aplicando el siguiente paso, podemos ver que efectivamente sí, la firma es completamente idéntica y pertenece a quien dice pertenecer. Finalizamos y con ello hemos terminado la ejecución de un primer Bitcoin Script.

Este proceso que acabo de explicar aquí de forma gráfica con BTCDEP es el mismo que se realiza una y otra vez con cada una de las operaciones que se llevan a cabo dentro de Bitcoin. Cada vez que un minero genera un bloque e incluye 1,000 o 1,200 transacciones dentro de ese bloque, estos bloques llegan a los nodos, que realizan estas operaciones una y otra vez hasta que terminan con las 1,200 operaciones y verifican que todo esté correcto. Luego de verificar que todo esté correcto, simplemente ingresan el bloque que ha enviado el dinero al listado de la blockchain y con ello se da el visto bueno a ese bloque, se valida y se genera consenso en la red. Todo este proceso se repite constantemente dentro de Bitcoin y en monedas que funcionan con el esquema de Bitcoin. Por ejemplo, puede ser Dash, que tiene un sistema muy parecido a Bitcoin Script. Puede ser Zcash, que también tiene un sistema bastante similar. Monero también tiene un sistema muy parecido, con adaptaciones para sus Bulletproof y su máquina virtual, porque ellos sí tienen una máquina virtual a nivel de ejecución. Pero las bases son estas que acabamos de ver en este ejemplo.

Si salimos aquí, podemos cerrar y ya con eso hemos terminado con un primer ejemplo. Vamos a ver un segundo ejemplo que he preparado. En este caso, ejemplo 02. Vamos a ejecutarlo aquí. Aquí cambia un poco la cuestión. Aquí vemos operaciones nuevas y vamos a explicar un poco de qué van estas operaciones nuevas. Vamos a dividir un poco el script para hacerlo más legible y luego les explicaré poco a poco cómo es cada una de estas operaciones. En este caso, ya tenemos los OP_DUP, OP_PUSH, PUSHBYTE, y tenemos aquí un tema de dirección y el hash.

Lo que ven en pantalla es una transacción del tipo SetTweet, como las que vemos normalmente en la actualidad dentro de la red, porque prácticamente la mayoría de las transacciones que se hacen son del tipo SetTweet o P2SH, que son muy parecidas también. En este caso, el script cambia un poco. El script empieza primero con un PUSHBYTE de 72 y un PUSHBYTE de 65. Al final, me da una clave pública. Luego nos pide que hagamos una duplicación del stack, que hagamos un hash 160 y luego hagamos un PUSHBYTE 20. Es decir, tomaremos los últimos 20 bytes y haremos un PUSH para verificar si esto es idéntico a lo que tenemos dentro del stack. Así funciona SetTweet. Aquí, como se puede ver, nos hace falta la formación de las claves, porque SetTweet divide esta información en dos partes. Las claves van por un lado, en lo que llamamos el witness o testigo, y la información de la transacción como tal va por el otro, que es lo que vamos a verificar en este punto.

Entonces, vamos a ejecutar este ejemplo y aquí tenemos nuestro stack cargado. Tenemos aquí unas advertencias que serían debido a que el BTC no está completamente sincronizado con los operadores de código de Bitcoin Script. Pero podemos simplemente obviar esto y seguir adelante. Vamos a hacer el primer paso y ahí cargamos la primera parte del stack. El segundo paso ya está descargado, seguimos cargando el siguiente paso. Aquí empiezan las operaciones de manipulación, de información y de verificación. Lo primero que vamos a hacer es una duplicación. Efectivamente, ya podemos ver la duplicación hecha. Aquí está. Luego viene la realización del hash 160 y aquí está nuestro hash 160 de la anterior operación. Seguimos con el siguiente paso, que es hacer el PUSHBYTE y finalmente cargamos la información de la firma y hacemos la verificación. Efectivamente, la firma es correcta. Hemos conseguido que la información sea correcta y que nos valide la operación. Esto significa que la operación SetTweet que acabamos de ver es correcta. Dentro del script que va a esta operación SetTweet, todas las operaciones están correctas.

Como puedes ver, es bastante sencillo utilizar BTCDEP para programar este tipo de cuestiones. Pueden ser directamente transacciones que hayas sacado de las operaciones de la mempool o de las operaciones dentro de Bitcoin. Por ejemplo, aquí podemos ver una transacción. Si vamos a los detalles, podemos ver toda la información necesaria para tal cuestión. Aquí está el script. Simplemente tomaríamos esta información, la colocaríamos dentro de BTCDEP y con ello podríamos verificar si efectivamente este script, tal como está escrito, que en este caso es una operación SetTweet y de tipo multifirma, tal como aparece aquí en la pantalla, ya con esto podríamos llegar a incluirlo dentro de BTCDEP y verificar si efectivamente la operación es correcta. O podemos ir paso a paso, como sería lo ideal.

En este caso, por ejemplo, si quiero hacer algo muy sencillo, como sería una suma, podríamos escribirlo así: BTCDEP OP_1, OP_2, OP_ADD. Y aquí ya tendríamos nuestro primer stack. Tendríamos el número 1, el número 2 y el OP_ADD. Simplemente pasamos paso a paso y tenemos nuestra operación de suma. La capacidad de BTC y de Bitcoin Script para permitirnos programar es muy amplia, aunque no llega a los niveles de Solidity o de otros lenguajes de programación de smart contracts Turing completos. Bitcoin Script nos permite hacer muchas cosas increíbles a nivel de programación descentralizada.

Quiero mostrarles parte de ese poder. Vamos aquí a un proyecto que utiliza Bitcoin Script para realizar un mercado de intercambio, un DEX, un exchange descentralizado. Este es Bisq. Bisq es un exchange descentralizado que funciona dentro de Bitcoin. De hecho, cuando instalas Bisq, realmente estás instalando un nodo de Bitcoin que funciona de forma completamente descentralizada. No tiene ningún intermediario, no funciona con un servidor web como otros servicios descentralizados, como en el caso de Uniswap. No necesitas ningún intermediario, como Infura en el caso de Uniswap y su wallet MetaMask. Absolutamente nada. Simplemente descargas este software, instalas tu propio nodo, instalas todos los servicios que necesitas y te conectas directamente a un exchange descentralizado en el que puedes intercambiar cualquier tipo de moneda.

Este es un ejemplo del potencial que existe detrás de Bitcoin Script. No solo es para programar operaciones sencillas. También puedes utilizarlo para programar aplicaciones como estas, que son mucho más complejas, que se apoyan en otras tecnologías para complementarse y realizar operaciones o aplicaciones, en este caso, para crear aplicaciones que sean completamente descentralizadas y que no tienen nada que envidiar a otras plataformas como Ethereum, Polkadot o cualquier otro tipo de plataforma web 3 como la conocemos normalmente. Pero también, y extrañamente, entra en lo que sería la web 3. La web 3 y el corazón de este MBA es demostrar que el mundo tal como lo conocemos ahora puede descentralizarse. Estos son ejemplos muy claros del poder de la descentralización que nos permite el Bitcoin Script. Espero que les haya gustado este video y nos veremos en otra ocasión.